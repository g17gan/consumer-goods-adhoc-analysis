WITH x AS (
	SELECT
		division,
		product_code,
		product,
		SUM(sold_quantity) AS total_sold_quantity
	FROM dim_product p
	JOIN fact_sales_monthly s
		USING(product_code)
	WHERE fiscal_year = 2021 
	GROUP BY division , product_code , product
),
y AS(
	SELECT 
		division,
		product_code,
		product,
		total_sold_quantity,
		DENSE_RANK() OVER(partition by division ORDER BY total_sold_quantity DESC) AS rank_order
	FROM x
)
SELECT 
	* 
FROM y 
WHERE rank_order <= 3 ;
